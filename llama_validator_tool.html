<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Llama Sanity Validator (Final Clean Version)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --primary:#673ab7; --ok:#81c784; --no:#e57373; --muted:#e0e0e0; --ink:#222; --bg:#fafafa; --card:#fff; --highlight-bg: #b3e5fc; 
  }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--ink); margin:0; }
  header { background: var(--primary); color:#fff; padding: 12px 20px; font-size: 1.1rem; font-weight: 600; display: flex; justify-content: space-between; }
  main { padding: 16px; max-width: 98%; margin:auto; }
  .bar { display:flex; flex-wrap: wrap; align-items:center; gap:16px; margin-bottom: 12px; } 
  button { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; background: var(--muted); font-weight: 500; }
  button:disabled { background: #e0e0e0; cursor: not-allowed; color: #9e9e9e; }
  button.primary { background: var(--primary); color:#fff; }
  button.ghost { background: transparent; border:1px solid #ddd; }
  button.ok { background: var(--ok); color:#fff; }
  button.no { background: var(--no); color:#fff; }
  button.toggle-on { outline: 2px solid #000; font-weight: bold; }
  .pill { padding: 6px 10px; border-radius: 999px; background:#f1f1f1; font-weight: bold; }
  .card { background: var(--card); border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
  .itemBox { border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
  .hl { background: var(--highlight-bg); padding: 1px 0; }
  .evidence-quote { color: #333; font-size: 0.9rem; margin-top: 8px; padding: 8px; background: #f7f7f7; border-radius: 4px; border: 1px solid #e5e5e5; font-family: monospace; white-space: pre-wrap; }
  .hl-number { display: inline-block; background: var(--primary); color: #fff; font-size: 0.75em; padding: 1px 4px; border-radius: 4px; vertical-align: super; margin-left: 2px; }
  .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .right { height: 85vh; position: sticky; top: 16px; }
  #reportCard { height: 100%; overflow-y: auto; }
  #llamaRevealBox { margin-bottom: 15px; padding: 15px; border-radius: 12px; border: 3px solid var(--primary); background: #f3e5f5; display: none; text-align: center; box-shadow: 0 4px 12px rgba(103, 58, 183, 0.2); }
  .hidden { display: none !important; }
  #summaryTable { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
  #summaryTable th, #summaryTable td { border: 1px solid #ddd; padding: 10px; text-align: center; }
  .match { color: #2e7d32; font-weight: bold; }
  .mismatch { color: #d32f2f; font-weight: bold; }
</style>
</head>
<body>

<header>
  <span>ReliefWeb Sanity Validator</span>
  <span id="counterPill" class="pill" style="background: rgba(255,255,255,0.2); color: white;">0 / 0</span>
</header>

<main id="root">
  <div class="bar">
    <button id="loadBtn" class="primary">üìÇ 1. Load Assignment</button>
    <button id="loadReportsBtn" class="primary">üìö 2. Load Reports</button>
    <button id="prevBtn" class="ghost" disabled>‚¨Ö Prev</button>
    <button id="nextBtn" class="ghost" disabled>Next (Reveal Llama) ‚û°</button>
    <button id="exportBtn" class="primary" disabled>üìä Toggle Summary & Export</button> 
    <span class="pill" id="idLabel"></span>
  </div>

  <div id="mainUI" class="split">
    <div id="leftCol" class="left">
      <div id="llamaRevealBox"></div>
      <div id="annotBox" class="card"></div>
    </div>
    <div id="rightCol" class="right">
      <div id="reportCard" class="card">Please load files to begin.</div>
    </div>
  </div>

  <div id="summarySection" class="card hidden" style="margin-top: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Sanity Check Results</h2>
        <button onclick="downloadJSONL()" class="primary">üíæ Download JSONL Results</button>
    </div>
    <div id="statsSummary" style="font-size: 1.2rem; margin-bottom: 10px;"></div>
    <table id="summaryTable">
      <thead>
        <tr>
          <th style="background: var(--primary); color: white;">#</th>
          <th style="background: var(--primary); color: white;">Query/Report ID</th>
          <th style="background: var(--primary); color: white;">Llama Label</th>
          <th style="background: var(--primary); color: white;">Your Label</th>
          <th style="background: var(--primary); color: white;">Result</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>
</main>

<script>
  let data = [], reportsDb = {}, idx = 0, answers = {}, revealState = false, summaryVisible = false;
  const $ = (id)=>document.getElementById(id);
  const keyOf = (x)=>`${x.timeline_query_id}|${x.report_id}`;

  $("loadBtn").onclick = async () => {
    try {
      const [handle] = await window.showOpenFilePicker();
      data = JSON.parse(await (await handle.getFile()).text());
      idx = 0; enableUI(); render();
    } catch(e) { console.error(e); }
  };

  $("loadReportsBtn").onclick = async () => {
    try {
      const [handle] = await window.showOpenFilePicker();
      const text = await (await handle.getFile()).text();
      text.split('\n').forEach(line => {
        if(!line.trim()) return;
        const r = JSON.parse(line); reportsDb[r.id] = r.description;
      });
      alert("Reports Database Loaded!"); render();
    } catch(e) { console.error(e); }
  };

  function enableUI() {
    $("loadBtn").disabled = true; $("loadReportsBtn").disabled = false;
    $("prevBtn").disabled = false; $("nextBtn").disabled = false; $("exportBtn").disabled = false;
  }

  function render() {
    if(!data.length) return;
    const sample = data[idx];
    const key = keyOf(sample);
    const pack = answers[key] || { items: [], bottom_line: null, align: null };
    
    revealState = false; 
    $("llamaRevealBox").style.display = "none";
    $("nextBtn").textContent = "Next (Reveal Llama) ‚û°";
    $("counterPill").textContent = `${idx + 1} / ${data.length}`;
    $("idLabel").textContent = `Q: ${sample.timeline_query_id} | R: ${sample.report_id}`;

    let html = `<h3>Per-Statement Judgments</h3>`;
    sample.items.forEach((it, i) => {
      const v = pack.items[i] || null;
      html += `
        <div class="itemBox">
          <div><b>${i+1}. Hypothesis:</b> ${it.hypothesis}</div>
          <div class="evidence-quote"><b>Evidence:</b> ${it.evidence || '(none)'}</div>
          <div style="margin-top:6px;">
            <button class="${v==='Support'?'ok':''}" onclick="setVerdict(${i}, 'Support')">Support</button>
            <button class="${v==='Not-Support'?'no':''}" onclick="setVerdict(${i}, 'Not-Support')">Not-Support</button>
          </div>
        </div>`;
    });

    html += `
      <div class="itemBox" style="border-top:2px solid #ddd; margin-top:20px;">
        <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
          <b>Timeline alignment:</b>
          <button class="${pack.align==='Yes'?'toggle-on':''}" onclick="setAlign('Yes')">Yes</button>
          <button class="${pack.align==='No'?'toggle-on':''}" onclick="setAlign('No')">No</button>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <b>Bottom line:</b>
          <button class="${pack.bottom_line==='Relevant'?'ok':''}" onclick="setBottom('Relevant')">Relevant</button>
          <button class="${pack.bottom_line==='Irrelevant'?'no':''}" onclick="setBottom('Irrelevant')">Irrelevant</button>
        </div>
      </div>`;
    $("annotBox").innerHTML = html;

    const reportText = reportsDb[sample.report_id] || "Load Reports JSONL to see text.";
    $("reportCard").innerHTML = `<h3>Report ${sample.report_id}</h3><div>${highlight(escapeHtml(reportText), sample.items.map((it, i) => ({ text: it.evidence || '', number: i + 1 })))}</div>`;
  }

  function setVerdict(i, val) {
    const key = keyOf(data[idx]);
    if(!answers[key]) answers[key] = { items: [], bottom_line: null, align: null };
    answers[key].items[i] = val;
    if (val === 'Not-Support') { 
        answers[key].bottom_line = 'Irrelevant'; 
        answers[key].align = 'No'; 
    }
    render();
  }

  function setAlign(val) {
    const key = keyOf(data[idx]);
    if(!answers[key]) answers[key] = { items: [], bottom_line: null, align: null };
    answers[key].align = val; render();
  }

  function setBottom(val) {
    const key = keyOf(data[idx]);
    if(!answers[key]) answers[key] = { items: [], bottom_line: null, align: null };
    answers[key].bottom_line = val; render();
  }

  $("nextBtn").onclick = () => {
    const key = keyOf(data[idx]);
    const a = answers[key];
    if(!a || !a.bottom_line) { alert("Please select a Bottom Line judgment first!"); return; }

    if(!revealState) {
      revealState = true;
      const llamaLabel = data[idx].llama_bottom_line;
      const isMatch = llamaLabel.toLowerCase() === a.bottom_line.toLowerCase();
      $("llamaRevealBox").style.display = "block";
      $("llamaRevealBox").innerHTML = `
        <div style="font-size: 1.4rem;">Llama Verdict: <b>${llamaLabel}</b></div>
        <div style="margin-top:5px; font-weight: bold; font-size: 1.1rem; color: ${isMatch?'#2e7d32':'#d32f2f'}">
          ${isMatch ? "‚úÖ Match!" : "‚ùå Mismatch"}
        </div>
      `;
      $("nextBtn").textContent = "Move to Next Pair ‚û°";
      $("leftCol").scrollTop = 0;
    } else {
      if(idx < data.length - 1) { idx++; render(); }
      else { alert("Finished all items! Use Toggle Summary to see stats."); }
    }
  };

  $("prevBtn").onclick = () => { if(idx > 0) { idx--; render(); } };

  $("exportBtn").onclick = () => {
    if (!summaryVisible) {
      $("mainUI").classList.add("hidden");
      $("summarySection").classList.remove("hidden");
      $("exportBtn").textContent = "üîô Back to Tagging";
      summaryVisible = true;
      updateSummaryTable();
    } else {
      $("summarySection").classList.add("hidden");
      $("mainUI").classList.remove("hidden");
      $("exportBtn").textContent = "üìä Toggle Summary & Export";
      summaryVisible = false;
    }
  };

  function updateSummaryTable() {
    let matches = 0, html = "";
    data.forEach((sample, i) => {
      const a = answers[keyOf(sample)], 
            userL = a ? a.bottom_line : "N/A", 
            llamaL = sample.llama_bottom_line, 
            isMatch = userL && userL.toLowerCase() === llamaL.toLowerCase();
      if(isMatch) matches++;
      html += `<tr><td>${i+1}</td><td>Q:${sample.timeline_query_id}/R:${sample.report_id}</td><td>${llamaL}</td><td>${userL}</td><td class="${isMatch?'match':'mismatch'}">${isMatch?'MATCH':'MISMATCH'}</td></tr>`;
    });
    $("summaryBody").innerHTML = html;
    $("statsSummary").innerHTML = `<b>Current Accuracy vs Llama:</b> ${(matches/data.length*100).toFixed(1)}% (${matches}/${data.length})`;
  }

  function downloadJSONL() {
    const out = data.map(sample => {
      const a = answers[keyOf(sample)];
      return a ? JSON.stringify({
        timeline_query_id: sample.timeline_query_id,
        report_id: sample.report_id,
        user_label: a.bottom_line,
        llama_label: sample.llama_bottom_line,
        items_judgments: a.items,
        timeline_alignment: a.align
      }) : null;
    }).filter(x => x);
    const blob = new Blob([out.join("\n")], {type:'application/x-ndjson'});
    const url = URL.createObjectURL(blob);
    const aEl = document.createElement('a');
    aEl.href = url; aEl.download = 'sanity_check_results.jsonl';
    aEl.click(); URL.revokeObjectURL(url);
  }

  function escapeHtml(str) { return (str || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  function highlight(html, evs) {
    let o = html;
    evs.sort((a,b)=>b.text.length-a.text.length).forEach(ev => {
      if(!ev.text || ev.text.length < 5) return;
      const escaped = ev.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\s+/g, '\\s+');
      const re = new RegExp(`(${escaped})`, 'gi');
      o = o.replace(re, `<span class="hl">$1</span><strong class="hl-number">(${ev.number})</strong>`);
    });
    return o.replace(/\n/g, "<br>");
  }
</script>
</body>
</html>
