<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ReliefWeb Query-Report Aligner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --primary:#673ab7;
    --ok:#81c784;
    --no:#e57373;
    --muted:#e0e0e0;
    --ink:#222;
    --bg:#fafafa;
    --card:#fff;
    --highlight-bg: #b3e5fc; 
  }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); margin:0; }
  header { background: var(--primary); color:#fff; padding: 12px 20px; font-size: 1.1rem; font-weight: 600; }
  main { padding: 16px; max-width: 95%; margin:auto; position: relative; }
  .bar { display:flex; flex-wrap: wrap; align-items:center; gap:16px; margin-bottom: 12px; } 
  button { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; background: var(--muted); }
  button:disabled { background: #e0e0e0; cursor: not-allowed; color: #9e9e9e; }
  button.primary { background: var(--primary); color:#fff; }
  button.ghost { background: transparent; border:1px solid #ddd; }
  button.ok { background: var(--ok); color:#fff; }
  button.no { background: var(--no); color:#fff; }
  button.toggle-on { outline: 2px solid #000; }
  .pill { padding: 6px 10px; border-radius: 999px; background:#f1f1f1; }
  .card { background: var(--card); border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
  .itemBox { border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
  
  .hl { background: var(--highlight-bg); }
  
  .itemBox > div:first-of-type { font-weight: 600; }

  .evidence-quote {
    color: #333;
    font-size: 0.95rem;
    margin-top: 8px;
    padding: 8px 10px;
    background: #f7f7f7;
    border-radius: 4px;
    border: 1px solid #e5e5e5;
    font-family: 'Menlo', 'Consolas', monospace;
    display: block;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .hl-number {
    display: inline-block;
    background: var(--primary);
    color: #fff;
    font-weight: 700;
    font-size: 0.85em;
    padding: 1px 5px;
    border-radius: 4px;
    vertical-align: super;
    margin-left: 4px;
    line-height: 1;
  }

  .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .split .left, .split .right { min-height: 70vh; }
  .right { height: 85vh; position: sticky; top: 16px; }
  #reportCard { height: 100%; overflow-y: auto; }

  .hidden { display:none; }
  .link { color: var(--primary); text-decoration: none; font-weight: 600; }
  .link:hover { text-decoration: underline; }
</style>
</head>
<body>

<header>ReliefWeb Query-Report Aligner</header>

<main id="root">
  <div class="bar">
    <button id="loadBtn" class="primary">ğŸ“‚ 1. Load Assignment File</button>
    <button id="loadReportsBtn" class="primary">ğŸ“š 2. Load Reports JSONL</button>
    <button id="prevBtn" class="ghost" disabled>â¬… Prev</button>
    <button id="nextBtn" class="ghost" disabled>Next â¡</button>
    <button id="jumpBtn" class="ghost" disabled>Jump toâ€¦</button>
    <button id="exportBtn" class="primary" disabled>ğŸ’¾ Export Annotations & Finish</button> 
    <span class="pill" id="idLabel"></span>
  </div>

  <div class="bar">
    <a id="openReliefBtn" class="link" href="#" target="_blank" rel="noopener">Open on ReliefWeb â†—</a>
    <a href="https://docs.google.com/document/d/1auuwhtO0oa85VmP35inx50JmyXsfozbE23WSNZ1uuuo/edit?tab=t.0#heading=h.c7i5k9zd9sod" class="link" target="_blank" rel="noopener">ğŸ“– Annotation Guidelines â†—</a>
  </div>

  <div id="content" class="split">
    <div id="leftCol" class="left">
      <div id="queryBox" class="card"></div>
      <div id="annotBox" class="card"></div>
    </div>

    <div id="rightCol" class="right">
      <div id="reportCard" class="card">
        Please load assignment and reports files to begin.
      </div>
    </div>
  </div>
</main>

<script>
  let data = [];
  let reportsDb = {};
  let idx = 0;
  let answers = {};

  const keyOf = (x)=>`${x.timeline_query_id}|${x.report_id}`;
  const $ = (id)=>document.getElementById(id);

  function forceExportAndEndTask() {
      if (!data || data.length === 0) return;

      const out = [];
      let annotatedCount = 0;
      
      for(const sample of data){ 
        if (!sample) continue; 

        const k = keyOf(sample);
        const a = answers[k];
        const isAnnotated = a && (a.align || a.bottom_line || (a.items && a.items.some(it => it !== null)));

        if (isAnnotated) {
            annotatedCount++;
            const rec = {
              timeline_query_id: sample.timeline_query_id,
              report_id: sample.report_id,
              response: buildMarkdownResponse(sample, a),
              parsed_response: buildParsed(sample, a),
              timeline_alignment: a.align || ""
            };
            out.push(JSON.stringify(rec));
        }
      }

      if (out.length > 0) {
          const blob = new Blob([out.join("\n")], {type:'application/x-ndjson'});
          const url = URL.createObjectURL(blob);
          const aEl = document.createElement('a');
          aEl.href = url;
          aEl.download = 'annotations_export.jsonl';
          aEl.click();
          URL.revokeObjectURL(url);
          alert(`×™×™×¦×•× ×”×•×©×œ×! ${annotatedCount} ×¤×¨×™×˜×™× × ×©××¨×•.`);
      } else {
           alert("No annotations were made to export."); 
      }

      disableUI();
      localStorage.clear();
  }

  function disableUI() {
      $("loadBtn").disabled = true;
      $("loadReportsBtn").disabled = true;
      $("prevBtn").disabled = true;
      $("nextBtn").disabled = true;
      $("jumpBtn").disabled = true;
      $("exportBtn").disabled = true;
  }

  function enableUI() {
      $("loadBtn").disabled = true; 
      $("loadReportsBtn").disabled = false; 
      $("prevBtn").disabled = false;
      $("nextBtn").disabled = false;
      $("jumpBtn").disabled = false;
      $("exportBtn").disabled = false;
  }

  function saveProgress(){ 
    localStorage.setItem("annotation_answers", JSON.stringify(answers)); 
    localStorage.setItem("annotation_idx", idx.toString());
  }

  function loadProgress(){
    try { answers = JSON.parse(localStorage.getItem("annotation_answers")||"{}"); }
    catch { answers = {}; }
    disableUI();
    $("loadBtn").disabled = false;
    $("loadReportsBtn").disabled = false;
  }

  function setIdx(n){
    if(!data.length) return;
    if($("exportBtn").disabled && !$("loadBtn").disabled) return; 
    if(n<0 || n>=data.length) return;
    
    idx = n;
    localStorage.setItem("annotation_idx", idx.toString());
    render();
  }

  function highlight(escapedReportHtml, evidenceItems){
    if(!escapedReportHtml) return "(No report text available)";
    let html = escapedReportHtml;
    const evidenceMap = new Map();
    for (const ev of (evidenceItems || []).filter(ev => ev.text)) {
      const cleanText = ev.text.replace(/\.+$/, '').trim();
      if (!cleanText) continue;
      if (!evidenceMap.has(cleanText)) evidenceMap.set(cleanText, []);
      if (!evidenceMap.get(cleanText).includes(ev.number)) evidenceMap.get(cleanText).push(ev.number);
    }
    const sortedEvidences = Array.from(evidenceMap.entries()).map(([text, numbers]) => ({
      text, numbers: numbers.sort((a,b) => a - b)
    })).sort((a, b) => b.text.length - a.text.length);

    for(const ev of sortedEvidences){
      try{
        const escapedParts = ev.text.match(/\S+/g).map(part => part.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        const re = new RegExp(`(${escapedParts.join('(?:\\s|\\*|_)+')})`, 'gi');
        const numbersLabel = ev.numbers.map(n => `(${n})`).join('');
        html = html.replace(re, `<span class="hl">$1</span><strong class="hl-number">${numbersLabel}</strong>`);
      } catch(e) {}
    }
    return html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/_(.*?)_/g, '<i>$1</i>').replace(/\n/g, "<br>");
  }

  function render(){
    if(!data.length) { $("reportCard").innerHTML = "Please load assignment file..."; return; }
    
    const sample = data[idx];
    const key = keyOf(sample);
    const expectedItemCount = sample.items?.length || 0;
    const pack = answers[key] || { items: Array(expectedItemCount).fill(null), bottom_line: null, align: null };
    answers[key] = pack;

    $("idLabel").textContent = `Query ${sample.timeline_query_id} | Report ${sample.report_id} (${idx + 1} / ${data.length})`;
    $("openReliefBtn").href = `https://reliefweb.int/node/${sample.report_id}`;

    $("queryBox").innerHTML = `<h3>Timeline Query</h3><ol>${(sample.timeline_query||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join("")}</ol>`;

    let html = `<h3>Per-Statement Judgments</h3>`;
    (sample.items || []).forEach((it,i)=>{
       const v = pack.items[i];
       html += `<div class="itemBox">
          <div><b>${i+1}. Hypothesis:</b> ${escapeHtml(it.hypothesis)}</div>
          <div class="evidence-quote"><b>Evidence:</b> ${escapeHtml(it.evidence)}</div>
          <div style="margin-top:6px;">
            <button class="${v==='Support'?'ok':''}" onclick="setVerdict(${i}, 'Support')">Support</button>
            <button class="${v==='Not-Support'?'no':''}" onclick="setVerdict(${i}, 'Not-Support')">Not-Support</button>
          </div>
        </div>`;
    });

    html += `<div class="itemBox"><b>Timeline alignment:</b> 
      <button class="${pack.align==='Yes'?'toggle-on':''}" onclick="setAlign('Yes')">Yes</button>
      <button class="${pack.align==='No'?'toggle-on':''}" onclick="setAlign('No')">No</button>
    </div>
    <div class="itemBox"><b>Bottom line:</b> 
      <button class="${pack.bottom_line==='Relevant'?'ok':''}" onclick="setBottom('Relevant')">Relevant</button>
      <button class="${pack.bottom_line==='Irrelevant'?'no':''}" onclick="setBottom('Irrelevant')">Irrelevant</button>
    </div>`;

    $("annotBox").innerHTML = html;
    const reportText = reportsDb[sample.report_id] || "(Report text not available)";
    $("reportCard").innerHTML = `<h3>Report (ID: ${sample.report_id})</h3><div>${highlight(escapeHtml(reportText), (sample.items||[]).map((it,i)=>({text:it.evidence, number:i+1})))}</div>`;
    
    $("prevBtn").disabled = idx === 0;
    $("nextBtn").disabled = idx === data.length - 1;
  }

  function escapeHtml(str){ return (str || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  function setVerdict(i, val){
    const k = keyOf(data[idx]);
    answers[k].items[i] = val;
    if (val === 'Not-Support') { answers[k].align = 'No'; answers[k].bottom_line = 'Irrelevant'; }
    saveProgress(); render();
  }

  function setAlign(val){
    const k = keyOf(data[idx]);
    if (answers[k].items.some(v => v === 'Not-Support') && val === 'Yes') return alert("Cannot set 'Yes' with 'Not-Support' items.");
    answers[k].align = val;
    if (val === 'No') answers[k].bottom_line = 'Irrelevant';
    saveProgress(); render();
  }

  function setBottom(val){
    const k = keyOf(data[idx]);
    const pack = answers[k];
    if (pack.items.some(v => v === 'Not-Support') && val === 'Relevant') return alert("Cannot be Relevant with Not-Support items.");
    if (val === 'Relevant' && (pack.align !== 'Yes' || pack.items.some(v => v !== 'Support'))) return alert("To be Relevant, all items must be Support and Align must be Yes.");
    pack.bottom_line = val;
    saveProgress(); render();
  }

  $("loadBtn").addEventListener("click", async ()=>{
    try {
      const [fileHandle] = await window.showOpenFilePicker();
      const text = await (await fileHandle.getFile()).text();
      data = JSON.parse(text);
      idx = parseInt(localStorage.getItem("annotation_idx") || "0");
      enableUI(); render();
    } catch(e) {}
  });

  $("loadReportsBtn").addEventListener("click", async () => {
    try {
      const [fileHandle] = await window.showOpenFilePicker();
      const text = await (await fileHandle.getFile()).text();
      text.split('\n').forEach(line => {
        try { const r = JSON.parse(line); reportsDb[r.id] = r.description; } catch(e){}
      });
      alert("Reports loaded."); render();
    } catch (e) {}
  });

  $("nextBtn").addEventListener("click", () => setIdx(idx + 1));
  $("prevBtn").addEventListener("click", () => setIdx(idx - 1));
  $("exportBtn").addEventListener("click", () => confirm("Export and finish?") && forceExportAndEndTask());
  $("jumpBtn").addEventListener("click", () => {
    const n = prompt(`Jump to (1-${data.length}):`);
    if(n > 0 && n <= data.length) setIdx(n-1);
  });

  function buildMarkdownResponse(sample, a){
    let lines = [`**Timeline Alignment:** ${a.align||''}`, ''];
    (sample.items||[]).forEach((it, i)=>{
      lines.push(`## Step ${i+1}: Assess statement`, `* **Hypothesis**: ${it.hypothesis}`, `* **Evidence**: ${it.evidence}`, `* **Verdict**: **${a.items[i]||''}**`, '');
    });
    lines.push(`The final answer is: $\\boxed{${a.bottom_line||''}}$`);
    return lines.join('\n');
  }

  function buildParsed(sample, a){
    return { items: (sample.items||[]).map((it, i)=>({ hypothesis: it.hypothesis, evidence: it.evidence, verdict: a.items[i]||'' })), bottom_line: a.bottom_line||'' };
  }

  window.onload = loadProgress;
</script>
</body>
</html>