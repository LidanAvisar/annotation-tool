<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ReliefWeb QA - Feedback & Nav</title>
<style>
  :root {
    --primary: #673ab7;
    --bg: #f5f5f5;
    --card: #fff;
    --single: #4caf50;
    --multiple: #ff9800;
    --error: #f44336;
    --chat: #2196f3;
  }
  body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: ltr; }
  .container { max-width: 900px; margin: auto; }
  .card { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
  
  header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; margin-bottom: 20px; padding-bottom: 10px; }
  
  .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

  .report-text { 
    white-space: pre-wrap; background: #fdfdfd; padding: 20px; border: 1px solid #e0e0e0; 
    height: 350px; overflow-y: auto; font-size: 1.05rem; line-height: 1.6; border-radius: 8px; margin-bottom: 20px;
  }
  
  .actions { display: flex; gap: 20px; justify-content: center; margin-top: 10px; }
  
  button { padding: 14px 28px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; transition: all 0.2s; }
  button:disabled { opacity: 0.3; cursor: not-allowed; }
  
  .btn-choice { background: #e0e0e0; color: #444; flex: 1; max-width: 200px; border: 3px solid transparent; }
  .btn-nav { background: #fff; border: 1px solid #ccc; font-size: 0.9rem; padding: 8px 16px; }

  /* Feedback Styles (The ones you liked) */
  .correct-selection { background: var(--single) !important; color: white !important; border: 3px solid #2e7d32; }
  .wrong-selection { background: var(--error) !important; color: white !important; border: 3px solid #b71c1c; }
  .chat-truth { border: 3px solid var(--chat) !important; position: relative; }
  .chat-truth::after { content: "CHAT'S CHOICE"; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--chat); font-weight: bold; }

  .feedback-area { text-align: center; margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2rem; }
  .feedback-correct { background: #e8f5e9; color: #2e7d32; }
  .feedback-wrong { background: #ffebee; color: #c62828; }

  .btn-next { background: var(--primary); color: white; margin-top: 15px; padding: 10px 40px; }
  .btn-finish { background: #333; color: white; width: 100%; margin-top: 20px; }

  /* Table Styles */
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; cursor: pointer; }
  tr:hover { background: #f0f0f0; }
  .row-match { color: var(--single); font-weight: bold; }
  .row-mismatch { color: var(--error); font-weight: bold; }

  .hidden { display: none; }
  .progress { font-weight: bold; color: var(--primary); }
</style>
</head>
<body>

<div class="container">
  <header>
    <h2>QA Tool: Feedback & Navigation</h2>
    <div id="statusInfo" class="hidden">Report <span id="progressDisplay" class="progress">0 / 0</span></div>
  </header>
  
  <div id="setupStep" class="card">
    <h3>1. Load Test Set</h3>
    <input type="file" id="fileInput" accept=".jsonl">
  </div>

  <div id="qaStep" class="card hidden">
    <div class="nav-bar">
        <button class="btn-nav" id="prevBtn" onclick="changeIndex(-1)">‚¨Ö Prev</button>
        <h3 id="reportIdDisplay" style="margin:0">ID: -</h3>
        <button class="btn-nav" id="nextBtn" onclick="changeIndex(1)">Next ‚û°</button>
    </div>

    <div id="reportText" class="report-text"></div>
    
    <div class="actions" id="actionButtons">
      <button id="btn-single" class="btn-choice" onclick="handleChoice('single')">Single (1)</button>
      <button id="btn-multiple" class="btn-choice" onclick="handleChoice('multiple')">Multiple (2)</button>
    </div>

    <div id="feedbackContainer" class="hidden">
        <div id="feedbackMsg" class="feedback-area"></div>
        <div style="text-align: center;">
            <button id="continueBtn" class="btn-next" onclick="autoAdvance()">Continue to Next Report ‚û°</button>
            <button id="backToTableBtn" class="btn-nav hidden" style="margin-top:10px" onclick="showFinalResults()">‚Ü© Back to Summary Table</button>
        </div>
    </div>

    <button id="viewResultsBtn" class="btn-finish hidden" onclick="showFinalResults()">üìä View Results Summary</button>
  </div>

  <div id="resultsStep" class="card hidden">
    <h3>Final Summary</h3>
    <p id="scoreSummary" style="font-size: 1.3rem;"></p>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Report ID</th>
          <th>Chat GPT</th>
          <th>Your Label</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="resultsTableBody"></tbody>
    </table>
    <button class="btn-next" style="width:100%" onclick="location.reload()">Restart / New File</button>
  </div>
</div>

<script>
  let testData = [];
  let currentIndex = 0;
  let userLabels = {}; 
  let isReviewMode = false;

  const $ = (id) => document.getElementById(id);

  $('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    testData = text.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    
    $('setupStep').classList.add('hidden');
    $('qaStep').classList.remove('hidden');
    $('statusInfo').classList.remove('hidden');
    renderItem();
  });

  function renderItem() {
    const item = testData[currentIndex];
    const userChoice = userLabels[currentIndex];
    const chatChoice = item.chat_label;

    $('reportIdDisplay').textContent = `Report ID: ${item.id}`;
    $('reportText').textContent = item.description;
    $('progressDisplay').textContent = `${currentIndex + 1} / ${testData.length}`;
    
    // UI Reset
    $('btn-single').className = 'btn-choice';
    $('btn-multiple').className = 'btn-choice';
    $('feedbackContainer').classList.add('hidden');
    $('btn-single').disabled = false;
    $('btn-multiple').disabled = false;
    $('viewResultsBtn').classList.add('hidden');

    // Navigation Buttons
    $('prevBtn').disabled = (currentIndex === 0);
    $('nextBtn').disabled = (currentIndex === testData.length - 1);

    // If already answered, show the feedback style you like
    if (userChoice) {
        showFeedback(userChoice, chatChoice);
    }

    if (isReviewMode) {
        $('backToTableBtn').classList.remove('hidden');
        $('continueBtn').classList.add('hidden');
    }

    $('reportText').scrollTop = 0;
  }

  function handleChoice(userLabel) {
    const chatLabel = testData[currentIndex].chat_label;
    userLabels[currentIndex] = userLabel;
    
    showFeedback(userLabel, chatLabel);
    
    if (!isReviewMode) {
        checkIfAllAnswered();
    }
  }

  function showFeedback(userLabel, chatLabel) {
    const isCorrect = userLabel === chatLabel;
    const userBtn = $(`btn-${userLabel}`);
    const chatBtn = $(`btn-${chatLabel}`);

    $('btn-single').disabled = true;
    $('btn-multiple').disabled = true;

    if (isCorrect) {
        userBtn.classList.add('correct-selection');
        $('feedbackMsg').textContent = "‚úÖ Correct! Matches Chat's classification.";
        $('feedbackMsg').className = "feedback-area feedback-correct";
    } else {
        userBtn.classList.add('wrong-selection');
        chatBtn.classList.add('chat-truth');
        $('feedbackMsg').textContent = `‚ùå Mismatch. Chat classified this as ${chatLabel.toUpperCase()}.`;
        $('feedbackMsg').className = "feedback-area feedback-wrong";
    }

    $('feedbackContainer').classList.remove('hidden');
  }

  function autoAdvance() {
    if (currentIndex < testData.length - 1) {
        currentIndex++;
        renderItem();
    } else {
        showFinalResults();
    }
  }

  function changeIndex(delta) {
    const newIdx = currentIndex + delta;
    if (newIdx >= 0 && newIdx < testData.length) {
        currentIndex = newIdx;
        renderItem();
    }
  }

  function checkIfAllAnswered() {
    if (Object.keys(userLabels).length === testData.length) {
        $('viewResultsBtn').classList.remove('hidden');
    }
  }

  function showFinalResults() {
    isReviewMode = true;
    $('qaStep').classList.add('hidden');
    $('resultsStep').classList.remove('hidden');
    
    let score = 0;
    const tbody = $('resultsTableBody');
    tbody.innerHTML = "";
    
    testData.forEach((item, i) => {
      const u = userLabels[i];
      const c = item.chat_label;
      const match = u === c;
      if (match) score++;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i+1}</td>
        <td>${item.id}</td>
        <td>${c.toUpperCase()}</td>
        <td>${u ? u.toUpperCase() : '-'}</td>
        <td class="${match ? 'row-match' : 'row-mismatch'}">${match ? '‚úÖ Match' : '‚ùå Mismatch'}</td>
      `;
      row.onclick = () => {
        currentIndex = i;
        $('resultsStep').classList.add('hidden');
        $('qaStep').classList.remove('hidden');
        renderItem();
      };
      tbody.appendChild(row);
    });

    const percent = Math.round((score / testData.length) * 100);
    $('scoreSummary').innerHTML = `Final Accuracy: <b>${percent}%</b> (${score} / ${testData.length})`;
  }

  // Keyboard Support
  document.addEventListener('keydown', (e) => {
    if ($('qaStep').classList.contains('hidden')) return;

    if (!$('btn-single').disabled) {
        if (e.key === '1') handleChoice('single');
        if (e.key === '2') handleChoice('multiple');
    } else {
        if (e.key === 'Enter' || e.key === ' ') {
            if (isReviewMode) showFinalResults();
            else autoAdvance();
        }
    }
    if (e.key === 'ArrowLeft') changeIndex(-1);
    if (e.key === 'ArrowRight') changeIndex(1);
  });
</script>
</body>
</html>
