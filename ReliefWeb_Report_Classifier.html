<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ReliefWeb QA - Instant Feedback</title>
<style>
  :root {
    --primary: #673ab7;
    --bg: #f5f5f5;
    --card: #fff;
    --single: #4caf50;
    --multiple: #ff9800;
    --error: #f44336;
  }
  body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: ltr; }
  .container { max-width: 900px; margin: auto; }
  .card { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
  
  header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; margin-bottom: 20px; padding-bottom: 10px; }
  
  .report-text { 
    white-space: pre-wrap; background: #fdfdfd; padding: 20px; border: 1px solid #e0e0e0; 
    height: 350px; overflow-y: auto; font-size: 1.05rem; line-height: 1.6; border-radius: 8px; margin-bottom: 20px;
  }
  
  .actions { display: flex; gap: 20px; justify-content: center; margin-top: 10px; }
  
  button { padding: 14px 28px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; transition: all 0.2s; }
  button:disabled { opacity: 0.3; cursor: not-allowed; }
  
  .btn-choice { background: #e0e0e0; color: #444; flex: 1; max-width: 200px; }
  
  /* Feedback Styles */
  .correct-selection { background: var(--single) !important; color: white !important; border: 3px solid #2e7d32; }
  .wrong-selection { background: var(--error) !important; color: white !important; border: 3px solid #b71c1c; }
  .chat-truth { border: 3px solid #2196f3; position: relative; }
  .chat-truth::after { content: "CHAT'S CHOICE"; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: #2196f3; font-weight: bold; }

  .feedback-area { text-align: center; margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2rem; }
  .feedback-correct { background: #e8f5e9; color: #2e7d32; }
  .feedback-wrong { background: #ffebee; color: #c62828; }

  .btn-next { background: var(--primary); color: white; margin-top: 15px; padding: 10px 40px; }
  
  .hidden { display: none; }
  .progress { font-weight: bold; color: var(--primary); }
</style>
</head>
<body>

<div class="container">
  <header>
    <h2>QA Tool: Instant Feedback</h2>
    <div id="statusInfo" class="hidden">Report <span id="progressDisplay" class="progress">0 / 0</span></div>
  </header>
  
  <div id="setupStep" class="card">
    <h3>1. Load Test Set</h3>
    <p>Upload your <b>test_set.jsonl</b> file:</p>
    <input type="file" id="fileInput" accept=".jsonl">
  </div>

  <div id="qaStep" class="card hidden">
    <h3 id="reportIdDisplay">ID: -</h3>
    <div id="reportText" class="report-text"></div>
    
    <div class="actions" id="actionButtons">
      <button id="btn-single" class="btn-choice" onclick="handleChoice('single')">Single (1)</button>
      <button id="btn-multiple" class="btn-choice" onclick="handleChoice('multiple')">Multiple (2)</button>
    </div>

    <div id="feedbackContainer" class="hidden">
        <div id="feedbackMsg" class="feedback-area"></div>
        <div style="text-align: center;">
            <button id="nextBtn" class="btn-next" onclick="nextReport()">Next Report ➡</button>
        </div>
    </div>
  </div>

  <div id="resultsStep" class="card hidden">
    <h3>Final Summary</h3>
    <p id="scoreSummary" style="font-size: 1.3rem;"></p>
    <button class="btn-next" onclick="location.reload()">Restart</button>
  </div>
</div>

<script>
  let testData = [];
  let currentIndex = 0;
  let score = 0;
  let isWaitingForNext = false;

  const $ = (id) => document.getElementById(id);

  $('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    testData = text.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    
    $('setupStep').classList.add('hidden');
    $('qaStep').classList.remove('hidden');
    $('statusInfo').classList.remove('hidden');
    renderItem();
  });

  function renderItem() {
    isWaitingForNext = false;
    const item = testData[currentIndex];
    $('reportIdDisplay').textContent = `Report ID: ${item.id}`;
    $('reportText').textContent = item.description;
    $('progressDisplay').textContent = `${currentIndex + 1} / ${testData.length}`;
    
    // Reset buttons
    $('btn-single').className = 'btn-choice';
    $('btn-multiple').className = 'btn-choice';
    $('btn-single').disabled = false;
    $('btn-multiple').disabled = false;
    
    $('feedbackContainer').classList.add('hidden');
    $('reportText').scrollTop = 0;
  }

  function handleChoice(userLabel) {
    if (isWaitingForNext) return;
    isWaitingForNext = true;

    const chatLabel = testData[currentIndex].chat_label;
    const isCorrect = userLabel === chatLabel;

    if (isCorrect) score++;

    // Visual Feedback on buttons
    const userBtn = $(`btn-${userLabel}`);
    const chatBtn = $(`btn-${chatLabel}`);

    if (isCorrect) {
        userBtn.classList.add('correct-selection');
        $('feedbackMsg').textContent = "✅ Correct! Matches Chat's classification.";
        $('feedbackMsg').className = "feedback-area feedback-correct";
    } else {
        userBtn.classList.add('wrong-selection');
        chatBtn.classList.add('chat-truth');
        $('feedbackMsg').textContent = `❌ Mismatch. Chat classified this as ${chatLabel.toUpperCase()}.`;
        $('feedbackMsg').className = "feedback-area feedback-wrong";
    }

    // Disable buttons
    $('btn-single').disabled = true;
    $('btn-multiple').disabled = true;

    // Show feedback and Next button
    $('feedbackContainer').classList.remove('hidden');
  }

  function nextReport() {
    currentIndex++;
    if (currentIndex < testData.length) {
        renderItem();
    } else {
        showFinalResults();
    }
  }

  function showFinalResults() {
    $('qaStep').classList.add('hidden');
    $('resultsStep').classList.remove('hidden');
    const percent = Math.round((score / testData.length) * 100);
    $('scoreSummary').innerHTML = `You agreed with the Chat in <b>${percent}%</b> of cases.<br>(${score} out of ${testData.length})`;
  }

  // Keyboard support
  document.addEventListener('keydown', (e) => {
    if ($('qaStep').classList.contains('hidden')) return;
    
    if (!isWaitingForNext) {
        if (e.key === '1') handleChoice('single');
        if (e.key === '2') handleChoice('multiple');
    } else {
        if (e.key === 'Enter' || e.key === ' ') nextReport();
    }
  });
</script>
</body>
</html>
