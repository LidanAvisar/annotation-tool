<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ReliefWeb Annotation Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --primary:#673ab7;
    --ok:#81c784;
    --no:#e57373;
    --muted:#e0e0e0;
    --ink:#222;
    --bg:#fafafa;
    --card:#fff;
  }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); margin:0; }
  header { background: var(--primary); color:#fff; padding: 12px 20px; font-size: 1.1rem; font-weight: 600; }
  main { padding: 16px; max-width: 95%; margin:auto; position: relative; }
  .bar { display:flex; flex-wrap: wrap; align-items:center; gap:8px; margin-bottom: 12px; }
  button { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; background: var(--muted); }
  button.primary { background: var(--primary); color:#fff; }
  button.ghost { background: transparent; border:1px solid #ddd; }
  button.ok { background: var(--ok); color:#fff; }
  button.no { background: var(--no); color:#fff; }
  button.toggle-on { outline: 2px solid #000; }
  .pill { padding: 6px 10px; border-radius: 999px; background:#f1f1f1; }
  .card { background: var(--card); border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
  .itemBox { border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
  .hl { background: #ffeb3b; }
  #progress { margin-left: 8px; color:#555; }
  
  /* ===== START NEW/MODIFIED STYLES ===== */
  
  .itemBox > div:first-of-type {
    font-weight: 600;
  }
  
  .evidence-quote {
    color: #333;
    font-size: 0.95rem;
    margin-top: 8px;
    padding: 8px 10px;
    background: #f7f7f7;
    border-radius: 4px;
    border: 1px solid #e5e5e5;
    font-family: 'Menlo', 'Consolas', monospace;
    display: block;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  /* ===== START STYLE CHANGE ===== */
  /* CSS for the evidence number (More visible) */
  .hl-number { 
    display: inline-block; /* Allows padding */
    background: var(--primary); /* Use primary color */
    color: #fff; /* White text */
    font-weight: 700; 
    font-size: 0.85em; /* A bit larger */
    padding: 1px 5px; /* Padding for tag look */
    border-radius: 4px; /* Rounded corners */
    vertical-align: super; /* Aligns nicely above baseline */
    margin-left: 4px; /* Space from the highlight */
    line-height: 1; /* Ensure tight line height */
  }
  /* ===== END STYLE CHANGE ===== */
  
  .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .split .left, .split .right { 
    min-height: 70vh;
  }
  .right {
    height: 85vh;
    position: sticky;
    top: 16px;
  }
  #reportCard {
    height: 100%;
    overflow-y: auto;
  }
  /* ===== END NEW/MODIFIED STYLES ===== */
  
  .hidden { display:none; }
  .link { color: var(--primary); text-decoration: none; font-weight: 600; }
  .link:hover { text-decoration: underline; }
</style>
</head>
<body>

<header>ReliefWeb Annotation Tool</header>

<main id="root">
  <div class="bar">
    <button id="loadBtn" class="primary">📂 1. Load Assignment JSON</button>
    <button id="loadReportsBtn" class="primary">📚 2. Load Reports JSONL</button>
    <button id="prevBtn" class="ghost">⬅ Prev</button>
    <button id="nextBtn" class="ghost">Next ➡</button>
    <button id="jumpBtn" class="ghost">Jump to…</button>
    <button id="exportBtn" class="primary">💾 Export JSONL</button>
    <span id="progress"></span>
    <span class="pill" id="idLabel"></span>
  </div>

  <div class="bar">
    <a id="openReliefBtn" class="link" href="#" target="_blank" rel="noopener">Open on ReliefWeb ↗</a>
  </div>

  <div id="content" class="split">
    <div id="leftCol" class="left">
      <div id="queryBox" class="card"></div>
      <div id="annotBox" class="card"></div>
    </div>

    <div id="rightCol" class="right">
      <div id="reportCard" class="card">
        Please load assignment and reports files...
      </div>
    </div>
  </div>
</main>

<script>
  let data = [];
  let reportsDb = {};
  let idx = 0;
  let answers = {};
  const keyOf = (x)=>`${x.timeline_query_id}|${x.report_id}`;

  const $ = (id)=>document.getElementById(id);

  function saveProgress(){ localStorage.setItem("annotation_answers", JSON.stringify(answers)); }
  function loadProgress(){
    try { answers = JSON.parse(localStorage.getItem("annotation_answers")||"{}"); }
    catch { answers = {}; }
  }

  function setIdx(n){
    if(!data.length) return;
    if(n<0 || n>=data.length) return;
    idx = n;
    render();
  }

  function percentDone(){
    if(!data.length) return 0;
    let done = 0;
    for(const s of data){
      const k = keyOf(s);
      const a = answers[k];
      if(!a) continue;
      const okItems = Array.isArray(a.items) && s.items && a.items.length===s.items.length && a.items.every(v=>v==='Support'||v==='Not-Support');
      if(okItems && (a.bottom_line==='Relevant'||a.bottom_line==='Irrelevant') && (a.align==='Yes'||a.align==='No')){
        done++;
      }
    }
    return Math.round(100*done/data.length);
  }

  function highlight(reportText, evidenceItems){
    if(!reportText) return "(No report text available)";
    let html = reportText;
    
    const evidenceMap = new Map();
    for (const ev of (evidenceItems || []).filter(ev => ev.text)) {
      const text = ev.text;
      if (!evidenceMap.has(text)) {
        evidenceMap.set(text, []);
      }
      if (!evidenceMap.get(text).includes(ev.number)) {
          evidenceMap.get(text).push(ev.number);
      }
    }
    
    const sortedEvidences = Array.from(evidenceMap.entries()).map(([text, numbers]) => ({ 
      text, 
      numbers: numbers.sort((a,b) => a - b)
    }));
    sortedEvidences.sort((a, b) => b.text.length - a.text.length);

    for(const ev of sortedEvidences){
      try{
        const escText = escapeHtml(ev.text).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(escText, 'gi');
        
        const numbersLabel = ev.numbers.map(n => `(${n})`).join('');
        
        // ===== START CODE CHANGE =====
        // Removed the '&nbsp;' to let margin handle spacing
        const replacement = `<span class="hl">$&</span><strong class="hl-number">${numbersLabel}</strong>`; 
        // ===== END CODE CHANGE =====
        
        html = html.replace(re, replacement);
      }catch(e){ console.error("Highlight regex error:", e); }
    }
    
    return html.replace(/\n/g, "<br>");
  }

  function render(){
    if(!data.length) {
      $("reportCard").innerHTML = "Please load assignment file...";
      return;
    }
    if(Object.keys(reportsDb).length === 0) {
      $("reportCard").innerHTML = "Please load reports JSONL file...";
    }

    const sample = data[idx];
    const key = keyOf(sample);
    const pack = answers[key] || { items:Array(sample.items?.length||0).fill(null), bottom_line:null, align:null };
    answers[key] = pack;

    $("progress").textContent = `Item ${idx+1} / ${data.length} — ${percentDone()}% done`;
    $("idLabel").textContent = `Query ${sample.timeline_query_id} | Report ${sample.report_id}`;
    $("openReliefBtn").href = `https://reliefweb.int/node/${sample.report_id}`;

    // Query card
    $("queryBox").innerHTML = `
      <h3 style="margin:0 0 8px 0;">Timeline Query</h3>
      <ol style="margin:0; padding-left: 22px;">
        ${(sample.timeline_query||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join("")}
      </ol>
    `;

    // Annotation card
    const items = sample.items || [];
    let html = `<h3 style="margin:0 0 10px 0;">Per-Statement Judgments</h3>`;
    items.forEach((it,i)=>{
      const v = pack.items[i];
      html += `
        <div class="itemBox">
          <div><b>${i+1}. Hypothesis:</b> ${escapeHtml(it.hypothesis||'')}</div>
          <div class="evidence-quote"><b>Evidence:</b> ${escapeHtml(it.evidence||'(none)')}</div>
          <div style="margin-top:6px;">
            <button class="${v==='Support'?'ok':''}" onclick="setVerdict(${i}, 'Support')">Support</button>
            <button class="${v==='Not-Support'?'no':''}" onclick="setVerdict(${i}, 'Not-Support')">Not-Support</button>
          </div>
        </div>`;
    });

    // Alignment buttons
    html += `
      <div class="itemBox" style="border-top:none;">
        <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
          <div><b>Timeline alignment:</b></div>
          <div>
            <button id="alYes" class="${pack.align==='Yes'?'toggle-on':''}" onclick="setAlign('Yes')">Yes</button>
            <button id="alNo" class="${pack.align==='No'?'toggle-on':''}" onclick="setAlign('No')">No</button>
          </div>
        </div>
      </div>
    `;

    // Bottom line buttons
    html += `
      <div class="itemBox" style="border-top:none;">
        <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
          <div><b>Bottom line:</b></div>
          <div>
            <button id="blRel" class="${pack.bottom_line==='Relevant'?'ok':''}" onclick="setBottom('Relevant')">Relevant</button>
            <button id="blIrrel" class="${pack.bottom_line==='Irrelevant'?'no':''}" onclick="setBottom('Irrelevant')">Irrelevant</button>
          </div>
        </div>
      </div>
    `;

    $("annotBox").innerHTML = html;

    const reportId = sample.report_id;
    const reportText = reportsDb[reportId] || `(Report ID ${reportId} not found. Please load the correct Reports JSONL file.)`;
    
    const evidenceItems = items.map((it, i) => ({ 
      text: it.evidence || '', 
      number: i + 1 
    }));
    
    let processedText = escapeHtml(reportText);
    
    processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    processedText = processedText.replace(/_(.*?)_/g, '<i>$1</i>');
    
    let finalHtml = highlight(processedText, evidenceItems);

    $("reportCard").innerHTML = `
      <h3 style="margin:0 0 8px 0;">Report (ID: ${sample.report_id})</h3>
      <div style="color:#666; font-size:.9rem; margin-bottom:6px;">Evidence strings are highlighted.</div>
      <div style="word-break: break-word;">${finalHtml}</div>
    `;
  }

  function escapeHtml(str){
    return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function setVerdict(i, val){
    const sample = data[idx];
    const k = keyOf(sample);
    answers[k] = answers[k] || { items:Array(sample.items?.length||0).fill(null), bottom_line:null, align:null };
    answers[k].items[i] = val;
    saveProgress(); render();
  }
  
  function setAlign(val){
    const sample = data[idx];
    const k = keyOf(sample);
    answers[k] = answers[k] || { items:Array(sample.items?.length||0).fill(null), bottom_line:null, align:null };
    answers[k].align = val;
    
    if (val === 'No') {
      answers[k].bottom_line = 'Irrelevant';
    }
    
    saveProgress(); render();
  }

  function setBottom(val){
    const sample = data[idx];
    const k = keyOf(sample);
    answers[k] = answers[k] || { items:Array(sample.items?.length||0).fill(null), bottom_line:null, align:null };
    const pack = answers[k];
    const items = sample.items || [];
    const hasHypotheses = items.length > 0;

    // --- 'Relevant' Rule ---
    if (val === 'Relevant') {
      const allSupport = hasHypotheses ? (pack.items.length === items.length && pack.items.every(h => h === 'Support')) : true;
      const alignmentIsYes = pack.align === 'Yes';
      
      let errors = [];
      if (!allSupport) {
        errors.push("• לא כל ההיפותזות סומנו כ-'Support'.");
      }
      if (!alignmentIsYes) {
        errors.push("• 'Timeline alignment' אינו 'Yes'.");
      }
      
      if (errors.length > 0) {
        alert("לא ניתן לסמן 'Relevant'.\nכדי לסמן 'Relevant', יש לעמוד בתנאים הבאים:\n\n" + errors.join("\n"));
        return;
      }
    }

    // --- 'Irrelevant' Rules ---
    if (val === 'Irrelevant') {
      const atLeastOneNotSupport = pack.items.some(h => h === 'Not-Support');
      const alignmentIsNo = pack.align === 'No';
      
      if (!atLeastOneNotSupport && !alignmentIsNo) {
        alert("לא ניתן לסמן 'Irrelevant'.\nיש לסמן 'Irrelevant' רק אם לפחות היפותזה אחת היא 'Not-Support' או אם 'Timeline alignment' הוא 'No'.");
        return;
      }

      const numSupport = pack.items.filter(h => h === 'Support').length;
      const numNull = pack.items.filter(h => h === null).length;
      const totalItems = pack.items.length;
      const oneSupportAndRestNull = hasHypotheses && (numSupport === 1) && ((numSupport + numNull) === totalItems);

      if (oneSupportAndRestNull) {
        alert("לא ניתן לסמן 'Irrelevant'.\nנראה שרק היפותזה אחת סומנה כ-'Support' ושאר ההיפותזות לא סומנו.\nאנא סיים לסמן את כל ההיפותזות.");
        return;
      }
    }

    answers[k].bottom_line = val;
    saveProgress(); 
    render();
  }

  // ===== UI events =====
  $("loadBtn").addEventListener("click", async ()=>{
    try {
      const [fileHandle] = await window.showOpenFilePicker({types:[{description:'JSON', accept:{'application/json':['.json']}}]});
      const file = await fileHandle.getFile();
      const text = await file.text();
      data = JSON.parse(text);
      loadProgress();
      idx = 0; 
      render();
    } catch(err) { console.error("Error loading assignment file:", err); }
  });

  $("loadReportsBtn").addEventListener("click", async () => {
    try {
      const [fileHandle] = await window.showOpenFilePicker({types:[{description:'JSONL', accept:{'application/x-ndjson':['.jsonl'], 'application/json':['.jsonl']}}]});
      const file = await fileHandle.getFile();
      const text = await file.text();
      
      reportsDb = {};
      const lines = text.split('\n');
      for (const line of lines) {
        if (line.trim() === "") continue;
        try {
          const report = JSON.parse(line);
          if (report.id && report.description) {
            reportsDb[report.id] = report.description;
          }
        } catch(e) { console.warn("Failed to parse line:", line, e); }
      }
      
      const count = Object.keys(reportsDb).length;
      alert(`Reports DB loaded successfully with ${count} reports.`);
      $("loadReportsBtn").textContent = `📚 Reports DB (${count} loaded)`;
      
      if (data.length > 0) {
        render();
      }
    } catch (err) {
      console.error("Error loading reports file:", err);
      alert("Could not load reports file. See console for details.");
    }
  });

  document.addEventListener("click", (e)=>{
    const t = e.target;
    
    if(t.id==="nextBtn"){
      const sample = data[idx];
      if (!sample) return;
      
      const k = keyOf(sample);
      const a = answers[k] || { items: [], bottom_line: null };
      
      const hasHypothesisItems = (sample.items && sample.items.length > 0);
      const atLeastOneAnswered = hasHypothesisItems
                            ? a.items.some(v => v === 'Support' || v === 'Not-Support') 
                            : true;
      
      const hasBottomLine = a.bottom_line === 'Relevant' || a.bottom_line === 'Irrelevant';
      
      let errors = [];
      if (hasHypothesisItems && !atLeastOneAnswered) {
        errors.push("• יש לענות לפחות על היפותזה אחת (Support / Not-Support).");
      }
      if (!hasBottomLine) {
        errors.push("• יש לבחור 'Bottom line' (Relevant / Irrelevant).");
      }
      
      if (errors.length > 0) {
        alert("אנא השלם את השדות הבאים לפני המעבר:\n\n" + errors.join("\n"));
      } else {
        setIdx(idx + 1);
      }
    }

    if(t.id==="prevBtn") setIdx(idx-1);
    
    if(t.id==="jumpBtn"){
      const n = prompt(`Jump to index (1..${data.length})`);
      if(!n) return;
      const j = Number(n)-1; if(!Number.isFinite(j)) return;
      setIdx(j);
    }
    
    if(t.id==="exportBtn"){
      const out = [];
      for(const sample of data){
        const k = keyOf(sample);
        const a = answers[k] || {};
        const rec = {
          timeline_query_id: sample.timeline_query_id,
          report_id: sample.report_id,
          response: buildMarkdownResponse(sample, a),
          parsed_response: buildParsed(sample, a),
          timeline_alignment: a.align || ""
        };
        out.push(JSON.stringify(rec));
      }
      const blob = new Blob([out.join("\n")], {type:'application/x-ndjson'});
      const url = URL.createObjectURL(blob);
      const aEl = document.createElement('a');
      aEl.href = url; aEl.download = 'annotations.jsonl'; aEl.click();
      URL.revokeObjectURL(url);
    }
  });

  function buildMarkdownResponse(sample, a){
    let lines = [];
    lines.push(`**Timeline Alignment:** ${a.align||''}`);
    lines.push('');
    (sample.items||[]).forEach((it, i)=>{
      lines.push(`## Step ${i+1}: Assess statement`);
      lines.push(`* **Hypothesis**: ${it.hypothesis||''}`);
      lines.push(`* **Evidence**: ${it.evidence||''}`);
      lines.push(`* **Verdict**: **${(a.items&&a.items[i])||''}**`);
      lines.push('');
    });
    lines.push(`The final answer is: $\\boxed{${a.bottom_line||''}}$`);
    return lines.join('\n');
  }

  function buildParsed(sample, a){
    return {
      items: (sample.items||[]).map((it, i)=>({
        hypothesis: it.hypothesis||'',
        evidence: it.evidence||'',
        verdict: (a.items&&a.items[i])||''
      })),
      bottom_line: a.bottom_line||''
    };
  }
</script>
</body>
</html>
